#!/usr/bin/env bash

BUILD_DIR = $1
CACHE_DIR = $2
ENV_DIR = $3

if [ ! -f "$ENV_DIR/MAXMIND_KEY" ]
	echo "-----> You must define the environment variable MAXMIND_KEY with your license key."

	exit 1
fi

if [ ! -f "$ENV_DIR/MAXMIND_PATH" ]
	echo "-----> You must define the environment variable MAXMIND_PATH with the path relative to the build directory where you would like to store the file."

	exit 1
fi

DB = "$CACHE_DIR/GeoIP2-ISP.mmdb"

if [ ! -f $DB ]
	echo "-----> Database does not exist in cache, downloading."

	TAR = "$CACHE_DIR/isp.tar.gz"

	curl -o $TAR -L "https://download.maxmind.com/app/geoip_download?edition_id=GeoIP2-ISP&suffix=tar.gz&license_key=$MAXMIND"

	echo "-----> Extracting $TAR"

	tar -zxvf $TAR --wildcards --no-anchored --strip=1 '*GeoIP2-ISP.mmdb'
	rm $TAR
fi

MAXMIND_PATH = `cat $ENV_DIR/MAXMIND_PATH`
SAVE = "$BUILD_DIR/$SAVE"

echo "-----> Copying $DB to $SAVE"

cp $DB $SAVE